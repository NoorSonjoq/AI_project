// src/middleware/uploadMiddleware.js
import multer from "multer";

/* ----------------------------------------------------------------
   âš™ï¸ Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„ØªØ®Ø²ÙŠÙ† ÙÙŠ Ø§Ù„Ø°Ø§ÙƒØ±Ø© (Ø¨Ø¯Ù„ Ø§Ù„Ø­ÙØ¸ Ø¹Ù„Ù‰ Ø§Ù„Ù‚Ø±Øµ)
   Ù„Ø£Ù†Ù†Ø§ Ù†Ø­ÙØ¸ Ø§Ù„Ù…Ù„Ù Ù…Ø¨Ø§Ø´Ø±Ø© Ø¯Ø§Ø®Ù„ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
------------------------------------------------------------------ */
const storage = multer.memoryStorage();

/* ----------------------------------------------------------------
   ğŸ“‚ Ø£Ù†ÙˆØ§Ø¹ Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…Ø³Ù…ÙˆØ­ Ø¨Ù‡Ø§ ÙÙ‚Ø· (CSV Ùˆ Excel)
------------------------------------------------------------------ */
const allowedTypes = [
  "text/csv",
  "application/vnd.ms-excel",
  "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",
];

/* ----------------------------------------------------------------
   ğŸ” ÙÙ„ØªØ± Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù Ù‚Ø¨Ù„ Ø±ÙØ¹Ù‡
------------------------------------------------------------------ */
const fileFilter = (req, file, cb) => {
  if (allowedTypes.includes(file.mimetype)) {
    cb(null, true);
  } else {
    cb(
      new Error("âŒ Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ…. ÙÙ‚Ø· Ù…Ù„ÙØ§Øª CSV Ø£Ùˆ Excel Ù…Ø³Ù…ÙˆØ­ Ø¨Ù‡Ø§.")
    );
  }
};

/* ----------------------------------------------------------------
   ğŸš€ Ø¥Ù†Ø´Ø§Ø¡ Multer instance Ù…Ø¹ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø­Ø¬Ù… Ø§Ù„Ø£Ù‚ØµÙ‰
------------------------------------------------------------------ */
export const upload = multer({
  storage,
  fileFilter,
  limits: {
    fileSize: parseInt(process.env.MAX_FILE_SIZE) || 10 * 1024 * 1024, // 10MB ÙƒØ­Ø¯ Ø§ÙØªØ±Ø§Ø¶ÙŠ
  },
});
